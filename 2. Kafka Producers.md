[[KAFKA]]

# Kafka Producers
Un producer es el componente que envía mensajes kafka, su responsabilidad es publicar de formas confiable, eficiente y ordenada

## Acknowledgemsnts (acks)
Define cuantos brokers deben confiar que un mensaje fue escrito antes de que el producer considere exitoso
### Valores Comunes
- **acks = 0**
	El producer  no espera ninguna confirmación
		-> Máxima velocidad, riesgo alto de perdida de mensajes
- **acks = 1**
	El leader de la partición confirma la escritura
		-> Balance entre rendimiento y confiabilidad
		-> Si el leader falla antes de replicar el mensaje puede perderse
- **acks = all** (o -1)
	El leader y todas las replicas en sincronía confirmar
		-> Máxima durabilidad, menor throughput
### Impacta directamente en:
- Durabilidad
- Latencia
- Riesgo de perdida de datos

---

## Reintentos (Retries)
Número de veces que el producer reenvía un mensaje si ocurre un error temporal (ej: timeout, error de red)
### Puntos importantes
- Kafka puede reenviar automáticamente mensajes fallidos
- Sin configuración adicional, los retires pueden proporcionar mensajes duplicados
- No todos los errores son reintentables
### Configuraciones relacionadas:
- **`retires`**
- **`retry.backoff.ms`**
### Problema Principal
Reintentar sin control puede romper el orden o generar duplicados

---

## Idempotencia
Garantiza que un mensaje no se escriba más de una vez, incluso si el producer lo reenvia
- Kafka asigna un producerId
- Cada mensaje tiene un número de secuencia
- El broker detecta duplicados y los desecha
### Requisitos:
- **`enable.idempotence=true`**
- **`Kafka >= 0.11`**
### Que soluciona?
- Mensajes duplicados
- Reintentos seguros
- Mejor confiabilidad

La idempotencia funciona por partición y por sesión del producer

---
## Orden (Ordering)
kafka garantiza el orden solo dentro de una misma partición

### Que puede romper el orden
- Retries sin idempotencia
- **`max.in.flight.request.per.connection > 1`**
- Errores de red con envios
### Como garantizar orden
- Usar la mis Key para que los mensajes vayan a la misma particón
- Habilitar idempotencia
- Configurar `max.in.flight.request.per.connection` correctamente
### Regla clave:
**Sin partición compartida, no hay orden garantizado**

---
## Duplicados
Mensajes que se escriben más de una vez en kafka generalmente por:
- retries
- timeouts
- fallos de red
- reintentos del producer
### Kafka por defecto:
- **At-leas-once delivery**: Es decir puede haber duplicados
### Como evitarlos:
- Idempotencia en el producer
- Manejo de offsets en el consumer
- Procesamiento idempotente del lado del consumidor

---
## **Resumen**
- **ACKS** -> Cuanta confirmación necesitas
- **RETRIES** -> Que pasa cuando algo falta
- **ITEMPOTENCIA** -> Evitan duplicados
- **ORDERING** -> Solo garantizando por partición
- **DUPLICADOS** -> Normales si no se controlan